{% extends "layout.html" %}
{% block content %}

<h2>📊 Playthrough Analytics 📊</h2>

<ul>
  <li><strong>Total:</strong> {{ stats.total }}</li>
  <li><strong>Correct:</strong> {{ stats.correct }} ({{ stats.correct_pct }}%)</li>
  <li><strong>Avg. Duration:</strong> {{ stats.avg_duration }} min</li>
  <p class="faded-analytics">
    P.S. The stats do not include test entries with <code>[Jen]</code> & <code>[Olivato]</code> tags
    (<span id="toggleTestEntries" onclick="toggleTestEntries()" style="cursor: pointer; color: #4da6ff; text-decoration: underline;">Hide Test Entries</span>).
  </p>
</ul>

<hr>

<table class="analytics-table">
  <thead>
    <tr>
      <th>Time</th>
      <th>Player</th>
      <th>Accused</th>
      <th>Correct?</th>
      <th>Duration</th>
    </tr>
  </thead>
  <tbody>
    {% for row in playthroughs %}
      <tr>
        <td>{{ row.timestamp.strftime("%Y-%m-%d %H:%M") }}</td>
        <td>{{ row.player_name or "—" }}</td>
        <td>{{ row.accused_name }}</td>
        <td>{{ "✅" if row.was_correct else "❌" }}</td>
        <td>{{ row.duration_minutes or "below 1" }} min</td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Script to filter out test playthrough entries -->
<script>
  let hideTests = true;

  function toggleTestEntries() {
    hideTests = !hideTests;
    const toggle = document.getElementById("toggleTestEntries");
    const rows = document.querySelectorAll(".analytics-table tbody tr");

    rows.forEach(row => {
      const playerCell = row.children[1];
      if (!playerCell) return;

      const name = playerCell.textContent.trim();
      const isTest = name.startsWith("[Jen]") || name.startsWith("[Olivato]");

      if (isTest) {
        row.style.display = hideTests ? "none" : "";
      }
    });

    toggle.textContent = hideTests ? "Show Test Entries" : "Hide Test Entries";
  }
</script>

{% endblock %}
